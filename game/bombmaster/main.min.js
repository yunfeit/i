var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},Block=function(t){function e(){var e=t.call(this)||this;e.positionList=BlockConfig.BlockShape[0].cubes;var i=windspirit.Util.randBigOpen(0,BlockConfig.BlockShape.length);e.color=BlockConfig.BlockShape[i].color,e.positionList=BlockConfig.BlockShape[i].cubes;for(var r=0;r<e.positionList.length;r++){var o=new Cube(e.color);o.x=Cube.cwidth*e.positionList[r].x+(Cube.cwidth>>1),o.y=Cube.cwidth*e.positionList[r].y+(Cube.cwidth>>1),e.addChild(o)}return e}return __extends(e,t),e}(egret.DisplayObjectContainer);Block.startScale=.6,__reflect(Block.prototype,"Block");var BlockConfig=function(){function t(){}return t}();BlockConfig.BlockShape=[{color:4,cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0}]},{color:4,cubes:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3}]},{color:7,cubes:[{x:0,y:0},{x:1,y:0},{x:0,y:1},{x:1,y:1}]},{color:6,cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0}]},{color:6,cubes:[{x:0,y:0},{x:0,y:1},{x:0,y:2}]},{color:9,cubes:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:2},{x:2,y:2}]},{color:9,cubes:[{x:0,y:2},{x:1,y:2},{x:2,y:2},{x:2,y:1},{x:2,y:0}]},{color:9,cubes:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:1,y:0},{x:2,y:0}]},{color:9,cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:2,y:1},{x:2,y:2}]},{color:3,cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0}]},{color:3,cubes:[{x:0,y:0},{x:0,y:1},{x:0,y:2},{x:0,y:3},{x:0,y:4}]},{color:8,cubes:[{x:0,y:0},{x:0,y:1}]},{color:8,cubes:[{x:0,y:0},{x:1,y:0}]},{color:2,cubes:[{x:0,y:0}]},{color:5,cubes:[{x:0,y:0},{x:0,y:1},{x:1,y:1}]},{color:5,cubes:[{x:0,y:1},{x:1,y:1},{x:1,y:0}]},{color:5,cubes:[{x:0,y:0},{x:0,y:1},{x:1,y:0}]},{color:5,cubes:[{x:0,y:0},{x:1,y:0},{x:1,y:1}]},{color:1,cubes:[{x:0,y:0},{x:1,y:0},{x:2,y:0},{x:0,y:1},{x:1,y:1},{x:2,y:1},{x:0,y:2},{x:1,y:2},{x:2,y:2}]}],__reflect(BlockConfig.prototype,"BlockConfig");var Bomb=function(t){function e(){var e=t.call(this)||this;return e.count=9,e.visibleCircleNum=0,e.skinName="BombSkin",e.fireworkMc=windspirit.Util.createMc("fire_json","fire_png","fire"),e.addChild(e.fireworkMc),e.fireworkMc.play(-1),windspirit.Util.setCenterAnchor(e.fireworkMc),e.updateCircle(),e.timer=new egret.Timer(125),e.endCircle.visible=!1,e.timer.addEventListener(egret.TimerEvent.TIMER,e.doTimer,e),e.addEventListener(egret.Event.REMOVED,e.onRemove,e),e}return __extends(e,t),e.prototype.onRemove=function(){this.timer.stop(),this.timer=null},e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.fireworkMc.x=this.width},e.prototype.doTimer=function(){this.visibleCircleNum++,this.visibleCircleNum%=this.circleLayer.numChildren+1,this.updateCircle()},e.prototype.updateCircle=function(){for(var t=0;t<this.circleLayer.numChildren;t++){var e=this.circleLayer.getChildAt(t);t<this.visibleCircleNum?e.visible=!0:e.visible=!1}},e.prototype.startWarning=function(){this.timer.start()},e.prototype.updateNumber=function(){this.number.text=this.count.toString()},e.prototype.decCount=function(){if(this.count--,3==this.count){this.startWarning();var t=this.parent.parent;t.setChildIndex(this.parent,t.numChildren)}this.count<=3&&windspirit.SoundManager.playAudio("warning"),this.updateNumber()},e.prototype.end=function(t){this.endCircle.visible=!0;var e=40;egret.Tween.get(this.endCircle).to({scaleX:e,scaleY:e},500).call(function(){t&&t()},this)},e}(eui.Component);__reflect(Bomb.prototype,"Bomb");var Cube=function(t){function e(i){var r=t.call(this)||this;return r.color=0,r.setColor(i),r.width=r.height=e.cwidth,r.bitmap=new egret.Bitmap,r.setTexture(),r.bitmap.x=e.cgap,r.bitmap.y=e.cgap,r.addChild(r.bitmap),windspirit.Util.setCenterAnchor(r),r}return __extends(e,t),e.prototype.setColor=function(t){this.color=t},e.getTexture=function(t){return void 0===t&&(t=0),RES.getRes("color_"+t)},e.prototype.setTexture=function(){this.bitmap.texture=e.getTexture(this.color)},e.prototype.addBomb=function(){this.bomb=new Bomb,this.bitmap.visible=!1,this.addChild(this.bomb)},e.prototype.clear=function(){var t=this;this.setColor(0),egret.Tween.get(this).to({scaleX:.5,scaleY:.5},200).call(function(){t.bomb&&(windspirit.Util.safeRemove(t.bomb),t.bitmap.visible=!0),t.setTexture()},this).to({scaleX:1,scaleY:1},200)},e}(egret.Sprite);Cube.cwidth=0,Cube.cgap=2,__reflect(Cube.prototype,"Cube");var GameLayer=function(t){function e(){var e=t.call(this)||this;return e.step=0,e.currentTarget=null,e.skinName="GameLayerSkin",e.bombTipLayer.visible=!1,e.gameLayer.visible=!0,e.addScoreLabel.visible=!1,windspirit.Util.setScale(e.addScoreLabel,.6),e.btnPause.addEventListener(egret.TouchEvent.TOUCH_TAP,e.onGamePause,e),e.btnHome.addEventListener(egret.TouchEvent.TOUCH_TAP,e.goBackHome,e),e.btnRestart.addEventListener(egret.TouchEvent.TOUCH_TAP,e.restart,e),e.btnResume.addEventListener(egret.TouchEvent.TOUCH_TAP,e.onGameResume,e),e.start(),e}return __extends(e,t),e.prototype.childrenCreated=function(){t.prototype.childrenCreated.call(this),this.updateBestScore()},e.prototype.updateBestScore=function(){var t=30;this.bestScore.text=windspirit.Util.formatNumber(windspirit.GameData.record);var e=this.bestScoreGroup.width+t+this.bestScore.width;this.bestScoreGroup.x=windspirit.Util.centerX-e/2,this.bestScore.anchorOffsetX=this.bestScore.width,this.bestScore.x=windspirit.Util.centerX+e/2},e.prototype.restart=function(){this.gameLayer.removeChildren(),this.start()},e.prototype.start=function(){this.blocks=[],this.score=0,this.updateScoreLabel(),this.pauseLayer.visible=!1,this.initStartComponents()},e.prototype.initStartComponents=function(){this.createGrid(),this.generateBlocks(),this.addTouchEvent()},e.prototype.addTouchEvent=function(){this.gameLayer.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.gameLayer.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.gameLayer.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this)},e.prototype.removeTouchEvent=function(){this.gameLayer.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.gameLayer.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this.gameLayer.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this)},e.prototype.createGrid=function(){this.grid=new Grid(this),this.gameLayer.addChild(this.grid),this.grid.addEventListener(Grid.event_bomb_end,this.bombEnd,this)},e.prototype.showAddscore=function(t,e){var i=this;this.addScoreLabel.visible=!0,this.addScoreLabel.alpha=1,this.addScoreLabel.text="+"+windspirit.Util.formatNumber(t),this.addScoreLabel.anchorOffsetX=this.addScoreLabel.width>>1,this.addScoreLabel.anchorOffsetY=this.addScoreLabel.height,this.addScoreLabel.x=e.x,this.addScoreLabel.y=e.y,egret.Tween.get(this.addScoreLabel).to({y:e.y-3*this.grid.height/Grid.size},500,egret.Ease.quadOut).to({y:e.y-this.grid.height/Grid.size,alpha:0},500,egret.Ease.quadIn).call(function(){i.addScoreLabel.visible=!1})},e.prototype.bombEnd=function(){windspirit.Util.shake(this,this.gameOver.bind(this))},e.prototype.showBombTip=function(t){var e=this;this.bombTipLayer.visible=!0,this.bombTip.anchorOffsetY=this.bombTip.height>>1,this.bombTip.y=-this.bombTip.height>>1,egret.Tween.get(this.bombTip).to({y:windspirit.Util.centerY},500,egret.Ease.cubicIn).wait(800).to({y:-this.bombTip.height>>1},500,egret.Ease.cubicOut).call(function(){e.bombTip.visible=!1,t()},this)},e.prototype.generateBlocks=function(){for(;this.blocks.length<Grid.newNum;){var t=new Block;t.scaleX=t.scaleY=Block.startScale,t.x=windspirit.Util.stageW,this.gameLayer.addChild(t),this.blocks.push(t)}for(var e=0;e<this.blocks.length;e++){var t=this.blocks[e],i=this.getBlockPos(t);t.y=i.y,t.x!=i.x&&egret.Tween.get(t).wait(200*e).to({x:i.x},300)}},e.prototype.getBlockPos=function(t){var e=this.blocks.indexOf(t),i=new egret.Point;return i.y=this.grid.y+this.grid.height+40,i.x=this.grid.x+this.grid.width/Grid.newNum*e+Math.max(this.grid.width/Grid.newNum-t.width>>1,0),i},e.prototype.onTouchBegin=function(t){if(!this.currentTarget)for(var e=t.stageX,i=t.stageY,r=0;r<this.blocks.length;r++){var o=(this.blocks[r],new egret.Rectangle);if(o.y=this.grid.y+this.grid.height,o.width=this.grid.width/this.blocks.length,o.height=180,o.x=this.grid.x+o.width*r,o.contains(e,i)){this.currentTarget=this.blocks[r];var s=this.getBlockTouchedPos(t);windspirit.SoundManager.playAudio("tap"),egret.Tween.get(this.currentTarget).to({scaleX:1,scaleY:1,x:s.x,y:s.y},100).call(this.previewPlaceCubes,this);break}}},e.prototype.onTouchMove=function(t){if(this.currentTarget){var e=this.getBlockTouchedPos(t);this.currentTarget.x=e.x,this.currentTarget.y=e.y,this.previewPlaceCubes()}},e.prototype.previewPlaceCubes=function(){if(this.currentTarget){var t=this.getPoints();this.grid.previewPlaceCubes(t,this.currentTarget.color)}},e.prototype.getBlockTouchedPos=function(t,e){void 0===e&&(e=this.currentTarget);var i=new egret.Point;return i.x=t.stageX-e.width/2,i.y=t.stageY-e.height-60,i},e.prototype.onTouchEnd=function(t){if(this.currentTarget){var e=this.getPoints();if(this.grid.isPlaceable(e))this.grid.placeCubes(e,this.currentTarget.color),windspirit.Util.safeRemove(this.currentTarget),this.blocks.splice(this.blocks.indexOf(this.currentTarget),1),this.grid.checkErasable(e),this.grid.step(),this.grid.isTriggerBomb()?this.touchEnabled=!1:(this.generateBlocks(),this.isGameOver()?this.gameOver():(this.step++,this.step%5==0&&this.grid.addBomb()));else{var i=this.getBlockPos(this.currentTarget);egret.Tween.get(this.currentTarget).to({scaleX:Block.startScale,scaleY:Block.startScale,x:i.x,y:i.y},250)}this.currentTarget=null}},e.prototype.getPoints=function(){for(var t=[],e=Math.round((this.currentTarget.x-this.grid.x)/Cube.cwidth),i=Math.round((this.currentTarget.y-this.grid.y)/Cube.cwidth),r=0;r<this.currentTarget.positionList.length;r++){var o=new egret.Point;o.x=this.currentTarget.positionList[r].x+e,o.y=this.currentTarget.positionList[r].y+i,t.push(o)}return t},e.prototype.addScore=function(t){this.score+=t,this.updateScoreLabel()},e.prototype.updateScoreLabel=function(){this.labelScore.text=windspirit.Util.formatNumber(this.score)},e.prototype.isGameOver=function(){for(var t=0;t<this.blocks.length;t++)for(var e=0;Grid.size>e;e++)for(var i=0;Grid.size>i;i++){for(var r=!0,o=0;o<this.blocks[t].positionList.length;o++){var s=this.blocks[t].positionList[o].x+e,n=this.blocks[t].positionList[o].y+i,a=new egret.Point(s,n);if(!this.grid.isEmpty(a)){r=!1;break}}if(r)return!1}return!0},e.prototype.onGamePause=function(){this.pauseLayer.visible=!0,this.removeTouchEvent(),this.menuLayer.y=windspirit.Util.stageH;var t=windspirit.Util.stageH-this.menuLayer.height>>1;egret.Tween.get(this.menuLayer).to({y:t-100},300).to({y:t},150)},e.prototype.onGameResume=function(){var t=this;egret.Tween.get(this.menuLayer).to({y:windspirit.Util.stageH+20},300).call(function(){t.addTouchEvent(),t.pauseLayer.visible=!1},this)},e.prototype.goBackHome=function(){windspirit.App.ins.restart()},e.prototype.gameOver=function(){windspirit.SoundManager.playAudio("audio_over"),this.btnPause.touchEnabled=!1,this.removeTouchEvent(),windspirit.GameData.score=this.score,this.score>windspirit.GameData.record&&windspirit.SoundManager.playAudio("newRecord"),windspirit.Net.uploadScore()},e}(eui.Component);__reflect(GameLayer.prototype,"GameLayer");var Grid=function(t){function e(i){var r=t.call(this)||this;r.cubes=[],r.bombs=[],r.gameLayer=i,Cube.cwidth=Cube.getTexture().textureWidth+2*Cube.cgap;for(var o=0;e.size>o;o++){for(var s=[],n=0;e.size>n;n++){var a=new Cube(0);a.x=Cube.cwidth*o+Cube.cwidth/2,a.y=Cube.cwidth*n+Cube.cwidth/2,r.addChild(a),s.push(a)}r.cubes.push(s)}return windspirit.GameData.isNewer,r.x=(windspirit.Util.stageW-r.width)/2,r.y=180,r}return __extends(e,t),e.prototype.addBomb=function(t){void 0===t&&(t=1),windspirit.SoundManager.playAudio("addBomb");for(var i=[],r=0;r<e.size;r++)for(var o=0;o<e.size;o++){var s=this.cubes[o][r];0==s.color||s.bomb||i.push(s)}for(var n=0;t>n;n++){var a=windspirit.Util.randBigOpen(0,i.length),s=i[a];s.addBomb(),this.bombs.push(s.bomb),i.splice(a,1),s.parent.setChildIndex(s,s.parent.numChildren-1)}},e.prototype.step=function(){for(var t in this.bombs){var e=this.bombs[t];e.decCount()}},e.prototype.deleteBomb=function(t){var e=this.bombs.indexOf(t);-1!=e&&this.bombs.splice(e,1)},e.prototype.isTriggerBomb=function(){var t=this;for(var i in this.bombs)if(0==this.bombs[i].count)return this.gameLayer.showBombTip(function(){t.bombs[i].end(function(){windspirit.SoundManager.playAudio("bomb_explode"),t.dispatchEventWith(e.event_bomb_end)})}),!0;return!1},e.prototype.placeCubes=function(t,e){windspirit.SoundManager.playAudio("putDown");for(var i=0;i<t.length;i++){var r=this.cubes[t[i].x][t[i].y];r.setColor(e),r.setTexture(),r.bitmap.alpha=1}},e.prototype.isPlaceable=function(t){for(var e=0;e<t.length;e++)if(!this.isEmpty(t[e]))return!1;return!0},e.prototype.previewPlaceCubes=function(t,i){for(var r=0;r<e.size;r++)for(var o=0;o<e.size;o++){var s=this.cubes[r][o];1!=s.bitmap.alpha&&(s.bitmap.alpha=1,s.setTexture())}if(this.isPlaceable(t))for(var n=0;n<t.length;n++){var s=this.cubes[t[n].x][t[n].y];s.setColor(i),s.setTexture(),s.bitmap.alpha=.5,s.setColor(0)}},e.prototype.isEmpty=function(t){return t.x<0||t.x>e.size-1||t.y<0||t.y>e.size-1||0!=this.cubes[t.x][t.y].color?!1:!0},e.prototype.clearCubes=function(t){for(var e in t){var i=t[e];this.deleteBomb(i.bomb),i.clear()}},e.prototype.checkErasable=function(t){var i=[],r=[],o=[],s=t[0].y,n=0,a=0;n=a=t[0].x;for(var c=0;c<t.length;c++){var h=t[c];if(s=Math.max(s,h.y),n=Math.min(n,h.x),a=Math.max(a,h.x),-1==r.indexOf(h.x)){r.push(h.x);for(var u=[],d=0;e.size>d;d++){var l=this.cubes[h.x][d];if(0==l.color)break;u.push(l)}if(u.length==e.size)for(var p in u)-1==i.indexOf(u[p])&&i.push(u[p])}if(-1==o.indexOf(h.y)){o.push(h.y);for(var u=[],y=0;e.size>y;y++){var l=this.cubes[y][h.y];if(0==l.color)break;u.push(l)}if(u.length==e.size)for(var b in u)-1==i.indexOf(u[b])&&i.push(u[b])}}var g=0;i.length?(this.clearCubes(i),windspirit.SoundManager.playAudio("clear"),g=i.length):g=t.length,this.gameLayer.addScore(g),s++,a++;var f=new egret.Point;f.x=this.x+(n+a)/2/e.size*this.width,f.y=this.y+s/e.size*this.height,this.gameLayer.showAddscore(g,f),windspirit.SoundManager.playAudio("audio_addScore")},e}(egret.DisplayObjectContainer);Grid.size=10,Grid.newNum=3,Grid.event_bomb_end="event_bomb_end",__reflect(Grid.prototype,"Grid");var Main=function(t){function e(){return t.call(this,"clearbombmaster")||this}return __extends(e,t),e.prototype.createGameScene=function(){this.gameLayer.removeChildren(),windspirit.SoundManager.playSound("bgMusic");var t=new StartLayer;t.addEventListener(windspirit.EVENT_START_GAME,this.start,this),this.gameLayer.addChild(t)},e.prototype.start=function(){this.gameLayer.removeChildren();var t=new GameLayer;this.gameLayer.addChild(t)},e.prototype.restart=function(){this.createGameScene()},e}(windspirit.App);__reflect(Main.prototype,"Main");var StartLayer=function(t){function e(){var e=t.call(this)||this;return e.btnFollow.addEventListener(egret.TouchEvent.TOUCH_TAP,e.doFollow,e),e}return __extends(e,t),e.prototype.doFollow=function(){windspirit.GameAPI.runApi(windspirit.api.followUs)},e}(windspirit.StartLayer);__reflect(StartLayer.prototype,"StartLayer");